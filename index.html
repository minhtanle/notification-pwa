<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notification App</title>
  <link rel="manifest" href="https://minhtanle.github.io/notification-pwa/manifest.json">

  <!-- <script src="https://minhtanle.github.io/notification-pwa/app-v2.js"></script> -->

    <!-- Thêm CSS của add-to-homescreen -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/add-to-homescreen@3.2.6/dist/style/addtohomescreen.min.css">

  <!-- Thêm JS của add-to-homescreen -->
  <script src="https://cdn.jsdelivr.net/npm/add-to-homescreen@3.2.6/dist/addtohomescreen.min.js"></script>
</head>
<body>
  <h1>Ứng dụng nhận thông báo</h1>

  <!-- Nút bật thông báo -->
  <button id="enable-notifications" aria-label="Bật thông báo">Bật thông báo</button>

  <!-- Nút cài đặt PWA -->
  <button id="install-pwa" aria-label="Cài đặt ứng dụng" style="display:none;">Cài đặt ứng dụng</button>

  <!-- Ô input hiển thị FCM Token -->
  <div>
    <label for="fcm-token">FCM Token:</label>
    <input type="text" id="fcm-token" readonly style="width: 100%; margin-top: 10px;">
  </div>

  <!-- Box hiển thị các thông báo nhận được -->
  <div>
    <h2>Thông báo nhận được:</h2>
    <div id="messages-box" style="border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; background: #f9f9f9;"></div>
  </div>

  <script>
    window.onerror = function (message, source, lineno, colno, error) {
        console.error('Global Error:', { message, source, lineno, colno, error });
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>

  <script>

    // Kiểm tra nếu đang chạy trên iOS và không có sự kiện beforeinstallprompt
    function isiOS() {
      return /iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    if (isiOS() && !('beforeinstallprompt' in window)) {
      // Cấu hình add-to-homescreen
      addToHomescreen({
        appID: 'notification-pwa', // ID duy nhất cho ứng dụng
        lifespan: 0, // Hiển thị banner mỗi lần tải trang (có thể tùy chỉnh)
        maxDisplayCount: 3, // Số lần banner được hiển thị
        message: 'Nếu bạn muốn sử dụng ứng dụng một cách thuận tiện hơn, hãy thêm ứng dụng vào màn hình chính của bạn.', // Tùy chỉnh thông điệp
        modal: true, // Hiển thị dưới dạng modal thay vì banner
        startDelay: 1, // Thời gian chờ trước khi hiển thị banner (giây)
        autostart: true // Tự động hiển thị
      });

      console.log('Hướng dẫn Add to Home Screen đã được kích hoạt.');
    } else {
      console.log('Trình duyệt hỗ trợ beforeinstallprompt hoặc không phải iOS.');
    }

    const baseURL = 'https://minhtanle.github.io/notification-pwa';

    console.log('Thông tin trình duyệt:', navigator.userAgent);

    if (!('beforeinstallprompt' in window)) {
        alert('Trình duyệt của bạn không hỗ trợ sự kiện cài đặt ứng dụng tự động. Vui lòng sử dụng nút "Thêm vào Màn hình chính" trên trình duyệt Safari.');
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('Sự kiện beforeinstallprompt được kích hoạt'); // Thêm log
    });

    document.addEventListener('DOMContentLoaded', function () {


        // Đăng ký Service Worker chính
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(`${baseURL}/sw.js`)
                .then((registration) => {
                    console.log('Service Worker chính đã được đăng ký:', registration);
                })
                .catch((error) => {
                    console.error('Lỗi khi đăng ký Service Worker chính:', error);
                });
        }

        // === Xử lý nút cài đặt PWA ===
        let deferredPrompt;
        const installBtn = document.getElementById('install-pwa');

        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('Sự kiện beforeinstallprompt được kích hoạt'); // Thêm log

            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'inline-block';
        });

        installBtn.addEventListener('click', () => {
            console.log('Người dùng nhấn nút cài đặt'); // Thêm log

            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('Người dùng đã cài đặt ứng dụng');
                    } else {
                        alert('Bạn cần cài đặt ứng dụng để tiếp tục sử dụng.');
                    }
                    deferredPrompt = null;
                });
            }
        });

        // === Kiểm tra nếu đang ở chế độ PWA mới load Firebase ===
        function isInStandaloneMode() {
            return (window.matchMedia('(display-mode: standalone)').matches) ||
                (window.navigator.standalone === true);
        }

        if (isInStandaloneMode()) {
            // Load Firebase scripts
            function loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }

            Promise.all([
                loadScript('https://minhtanle.github.io/notification-pwa/firebase-app.js'),
                loadScript('https://minhtanle.github.io/notification-pwa/firebase-messaging.js')
            ]).then(() => {
                initFirebaseMessaging();
            }).catch((err) => {
                console.error('Không thể load Firebase scripts:', err);
            });

            function initFirebaseMessaging() {
                const firebaseConfig = {
                    apiKey: "AIzaSyC1kOGCzjIJv9_tNyp4mV3R8Peiyz24K5c",
                    authDomain: "notifycationpwa.firebaseapp.com",
                    projectId: "notifycationpwa",
                    storageBucket: "notifycationpwa.firebasestorage.app",
                    messagingSenderId: "196088165519",
                    appId: "1:196088165519:web:9efab7258ff41e37bb6cfa",
                    measurementId: "G-SHFKPPP2DM"
                };

                const vapidKey = 'BDi3xzJpUidCPQbHzQ1wdaojtTwcoHK3toUWBOdGfM00CMy5PLwZNx3YAEdakuKc8wZ65EXPfy6eW-1T0ih4Fds';

                firebase.initializeApp(firebaseConfig);
                const messaging = firebase.messaging();

                const enableNotificationsButton = document.getElementById('enable-notifications');
                const fcmTokenInput = document.getElementById('fcm-token');
                const messagesBox = document.getElementById('messages-box');

                // Đăng ký Service Worker
                if ('serviceWorker' in navigator) {
                    const version = new Date().getTime();
                    navigator.serviceWorker.register(`${baseURL}/firebase-messaging-sw.js?v=${version}`)
                        .then((registration) => {
                            console.log('Service Worker đã được đăng ký:', registration);
                            messaging.useServiceWorker(registration);
                        })
                        .catch((error) => {
                            console.error('Lỗi khi đăng ký Service Worker:', error);
                        });
                } else {
                    console.warn('Trình duyệt không hỗ trợ Service Worker.');
                }

                // Bật thông báo
                enableNotificationsButton.addEventListener('click', () => {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            messaging.getToken({ vapidKey })
                                .then(token => {
                                    console.log('FCM Token:', token);
                                    fcmTokenInput.value = token;
                                })
                                .catch(err => console.error('Error getting token', err));
                        } else {
                            alert('Vui lòng bật thông báo trong trình duyệt.');
                        }
                    });
                });

                // Xử lý thông báo foreground
                messaging.onMessage((payload) => {
                    console.log('Message received:', payload);

                    const messageElement = document.createElement('div');
                    messageElement.textContent = `${payload.notification.title}: ${payload.notification.body}`;
                    messagesBox.appendChild(messageElement);

                    if ('Notification' in window) {
                        new Notification('App ' + payload.notification.title, {
                            body: payload.notification.body,
                            icon: 'icon-192.png'
                        });
                    } else {
                        console.warn('Notification API không được hỗ trợ.');
                    }
                });
            }
        } else {
            alert('Vui lòng cài đặt ứng dụng để sử dụng.');
            installBtn.style.display = 'inline-block';
        }
    });
  </script>
</body>
</html>